(function(m,p){typeof exports=="object"&&typeof module<"u"?p(exports):typeof define=="function"&&define.amd?define(["exports"],p):(m=typeof globalThis<"u"?globalThis:m||self,p(m.DelaunayVoronoi={}))})(this,function(m){"use strict";function p(r){return r.length}function $(r,e,n){n===void 0&&(n=-1),n===-1&&(n=r.length);for(var t=r[0]*e[0],a=1;a<n;++a)t+=r[a]*e[a];return t}function G(r){for(var e=r.length,n=r[0]*r[0],t=1;t<e-1;++t)n+=r[t]*r[t];if(n===0)return r;n=1/Math.sqrt(n);for(var t=0;t<e;++t)r[t]*=n;return r}function P(r,e,n,t,a){for(var o=0,u=0,s=0;s<a;++s)if(s!==n){u=0;for(var i=0;i<a;++i)i!==t&&(e[o][u]=r[s][i],++u);++o}}function I(r){for(var e=new ArrayBuffer(r*r*4),n=[],t=0;t<r;++t)n[t]=new Float32Array(e,t*r<<2,r);return n}function O(r,e){if(e===1)return r[0][0];if(e===2)return r[0][0]*r[1][1]-r[0][1]*r[1][0];if(e===3)return r[0][0]*r[1][1]*r[2][2]+r[0][1]*r[1][2]*r[2][0]+r[0][2]*r[1][0]*r[2][1]-r[0][2]*r[1][1]*r[2][0]-r[0][1]*r[1][0]*r[2][2]-r[0][0]*r[1][2]*r[2][1];for(var n=1,t=0,a=I(e-1),o=0;o<e;++o)P(r,a,0,o,e),t+=n*r[0][o]*O(a,e-1),n=-n;return t}function H(r,e){var n=r[0].length;if(e=e||new Float32Array(n),n===3){var t=r[0],a=r[1],o=t[0],u=t[1],s=t[2],i=a[0],f=a[1],v=a[2];e[0]=u*v-s*f,e[1]=s*i-o*v,e[2]=o*f-u*i}else for(var c=n%2?-1:1,h=I(n-1),l=0;l<n;++l)P(r,h,n-1,l,n),e[l]=c*O(h,n-1),c=-c;return e}function S(r,e){var n=r.length,t=r[0],a=[];e=e||new Float32Array(n+1);for(var o=1;o<n;++o){for(var u=r[o],s=[],i=0;i<n;++i)s[i]=t[i]-u[i];a.push(s)}return H(a,e),e[n]=-$(t,e,n),G(e),e}function D(r){for(var e=r.length,n=0;n<e;++n)r[n]=-r[n];return r}function x(r,e,n){n===void 0&&(n=-1),n===-1&&(n=r.length);for(var t=e[n],a=0;a<n;++a)t+=r[a]*e[a];return t}var J=function(){function r(e){this.verts=[],this.facet=e}return r.prototype.getPlane=function(e,n){return this._plane||(this._plane=S(this.verts.map(function(t){return e[t]})),x(n,this._plane)>0&&D(this._plane)),this._plane},r}(),F=function(){function r(){this.ridges=[],this.verts=[]}return r}();function K(r,e,n){for(var t=e.verts,a=t.length,o=0,u=n;o<u.length;o++)for(var s=u[o],i=0,f=s.ridges;i<f.length;i++){var v=f[i];if(!v.neighbor){for(var c=!0,h=0;h<a;++h)c=c&&v.verts.indexOf(t[h])>=0;if(c){e.neighbor=v,v.neighbor=e;return}}}}function C(r,e,n,t){var a=r.ridges.map(function(f){return e[f.verts[0]]}),o=r.plane=S(a);if(t&&x(t,o,n)>0){D(o),r.verts.reverse(),r.ridges.reverse();for(var u=0,s=r.ridges;u<s.length;u++){var i=s[u];i.verts.reverse()}}}function M(r,e,n){for(var t=r.verts,a=r.ridges,o=a.length;o<n;++o){for(var u=new J(r),s=0;s<n-1;++s)u.verts[s]=t[(o+s)%n];u.opposite=t[(o+n)%n],K(r,u,e),r.ridges.push(u)}}function Q(r,e,n,t,a,o){var u=new F;return u.verts=r.verts.concat([e]),u.ridges.push(r),r.facet=u,r.opposite=e,M(u,t,o),C(u,n,o,a),u}function U(r,e,n){var t=e?e[0]:0,a=r[t],o=a.length,u=e?e.length:o+1;if(n)for(var s=0;s<o;++s)n[s]=a[s];else n=a.slice();for(var s=0;s<o;++s){for(var i=1;i<u;++i){var f=e?e[i]:i;n[s]+=r[f][s]}n[s]/=u}return n}function W(r,e){for(var n=r[0].length,t=n+1,a=[],o=0;o<=n;++o){for(var u=new F,s=0;s<n;++s){var i=(o+s)%t;u.verts[s]=e?e[i]:i}M(u,a,n);var f=(o+n)%(n+1),v=r[e?e[f]:f];C(u,r,n,v),a.push(u)}return a}function X(r){for(var e=r.length,n,t;e!==0;)t=Math.floor(Math.random()*e),e-=1,n=r[e],r[e]=r[t],r[t]=n;return r}function Y(r,e){console.assert(e<r.length,"Index out of bounds!");var n=r.pop();return r.length>0&&n!==r[e]&&(r[e]=n),e}function Z(r,e){for(var n=e.slice().sort(function(u,s){return s-u}),t=0,a=n;t<a.length;t++){var o=a[t];Y(r,o)}return r}function T(r,e){var n=r.pop();if(n===e)return r.length;var t=r.indexOf(e);if(t===-1)throw r.push(n),new Error("Removing component that's not present");return r[t]=n,t}var b=1e-4,z=function(){function r(){this.outsideSet=[],this.outsideDist=[]}return r}();function j(r){var e=r.meta,n=e.outsideSet,t=e.outsideDist,a=n.length;if(a===0)return-1;for(var o=n[0],u=t[0],s=1;s<a;++s)t[s]>u&&(u=t[s],o=n[s]);return o}function R(r,e,n,t){for(var a=n.map(function(y){return[]}),o=r.length,u=0;u<o;++u)for(var s=r[u],i=e[s],f=0,v=n;f<v.length;f++){var c=v[f],h=x(i,c.plane,t);if(h>b){var l=c.meta;l.outsideSet.push(s),l.outsideDist.push(h);break}}return a}function q(r,e,n,t,a){n.push(e),e.meta.currentPoint=r;for(var o=0,u=e.ridges;o<u.length;o++){var s=u[o],i=s.neighbor.facet;i.meta.currentPoint!==r&&(x(r,i.plane,a)>b?q(r,i,n,t,a):t.push(s))}}function _(r,e,n,t,a){for(var o=[],u=0,s=n;u<s.length;u++){var i=s[u],f=Q(i,e,r,o,t,a);f.meta=new z,o.push(f)}return o}function A(r,e,n,t){for(var a=n[r],o=n[e],u=0;u<t;++u){if(a[u]<o[u])return e;if(a[u]>o[u])return r}return e}function rr(r,e,n,t){for(var a=n[r],o=n[e],u=0;u<t;++u){if(a[u]>o[u])return e;if(a[u]<o[u])return r}return e}function er(r,e){for(var n=r.length,t=0,a=0,o=1;o<n;++o)a=A(o,a,r,e),t=rr(o,t,r,e);for(var u=[t,a],s=[r[t],r[a]],o=2;o<e+1;++o){for(var i=S(s),f=-1/0,v=-1,c=0;c<n;++c){var h=Math.abs(x(r[c],i,o));h>f&&(f=h,v=c)}u.push(v),s.push(r[v])}return u}function k(r){var e=r.length;if(e!==0){var n=p(r[0]);if(e<=n)throw new Error("A convex hull in "+n+" dimensions requires at least "+(n+1)+" points.");for(var t=[],a=0;a<e;++a)t.push(a);for(var o=er(r,n),u=U(r,o),s=W(r,o),i=0,f=s;i<f.length;i++){var v=f[i];v.meta=new z}Z(t,o),X(t),R(t,r,s,n);for(var c=!1;!c;){c=!0;for(var a=0;a<s.length;++a){var h=s[a],l=j(h);if(l!==-1){T(h.meta.outsideSet,l);var y=[],w=[];q(r[l],h,y,w,n);for(var d=_(r,l,w,u,n),g=0,L=y;g<L.length;g++){var V=L[g];T(s,V)<=a&&--a,R(V.meta.outsideSet,r,d,n),V.meta.outsideSet.length>0&&(c=!1)}s.push.apply(s,d)}}}for(var E=0,N=s;E<N.length;E++){var v=N[E];v.meta=null}return s}}function nr(r,e){for(var n=e+1,t=r.length,a=n<<2,o=new ArrayBuffer((t+1)*a),u=0,s=0,i=r[0].slice(),f=r[0].slice(),v=r.map(function(l){for(var y=new Float32Array(o,u,n),w=0,d=0;d<e;++d){var g=l[d];y[d]=g,g<i[d]&&(i[d]=g),g>f[d]&&(f[d]=g),w+=g*g}return y[e]=w,w>s&&(s=w),u+=a,y}),c=new Float32Array(o,t*a,n),h=0;h<e;++h)c[h]=(i[h]+f[h])*.5;return c[e]=s,v.push(c),v}function tr(r){var e=p(r[0]),n=r.length;if(n===e+1)return k(r);var t=nr(r,e),a=k(t);return a.filter(function(o){if(o.plane[e]>=0){for(var u=0,s=o.ridges;u<s.length;u++){var i=s[u];i.neighbor&&(i.neighbor.neighbor=null)}return!1}return!0})}function or(r,e){const n=r[0]*(r[4]*r[8]-r[5]*r[7])-r[1]*(r[3]*r[8]-r[5]*r[6])+r[2]*(r[3]*r[7]-r[4]*r[6]);if(Math.abs(n)<1e-10)return null;const t=1/n,a=[(r[4]*r[8]-r[7]*r[5])*t,(r[2]*r[7]-r[1]*r[8])*t,(r[1]*r[5]-r[2]*r[4])*t,(r[5]*r[6]-r[3]*r[8])*t,(r[0]*r[8]-r[2]*r[6])*t,(r[2]*r[3]-r[0]*r[5])*t,(r[3]*r[7]-r[6]*r[4])*t,(r[1]*r[6]-r[0]*r[7])*t,(r[0]*r[4]-r[1]*r[3])*t];return[a[0]*e[0]+a[1]*e[1]+a[2]*e[2],a[3]*e[0]+a[4]*e[1]+a[5]*e[2],a[6]*e[0]+a[7]*e[1]+a[8]*e[2]]}function ar(r,e,n,t){const a=[e[0]-r[0],e[1]-r[1],e[2]-r[2]],o=[n[0]-r[0],n[1]-r[1],n[2]-r[2]],u=[t[0]-r[0],t[1]-r[1],t[2]-r[2]],s=[a[0],a[1],a[2],o[0],o[1],o[2],u[0],u[1],u[2]],i=[(a[0]**2+a[1]**2+a[2]**2)*.5,(o[0]**2+o[1]**2+o[2]**2)*.5,(u[0]**2+u[1]**2+u[2]**2)*.5],f=or(s,i);return f===null?null:[r[0]+f[0],r[1]+f[1],r[2]+f[2]]}function ur(r,e,n,t){return[(r[0]+e[0]+n[0]+t[0])*.25,(r[1]+e[1]+n[1]+t[1])*.25,(r[2]+e[2]+n[2]+t[2])*.25]}class B{constructor(e){if(!e||e.length<4||!Array.isArray(e[0]))throw new Error("Input must be an array of at least 4 points, e.g., [[x,y,z], ...]");if(e[0].length!==3)throw new Error("Each point must have exactly 3 coordinates [x,y,z]");this.points=e,this.tetrahedra=[],this.voronoiVertices=[],this.voronoiEdges=[],this.adjacency=new Map}compute(e={}){const{voronoiCenterType:n="circumcenter"}=e;return this._computeDelaunay(),this._buildAdjacency(),this._computeVoronoi(n),this}_computeDelaunay(){const e=tr(this.points);this.tetrahedra=e.map(n=>{if(!n.verts)throw new Error("Invalid facet structure from Delaunay computation");return n.verts.map(t=>{if(t.id!==void 0)return t.id;if(t.index!==void 0)return t.index;if(t.i!==void 0)return t.i;if(typeof t=="number")return t;throw new Error("Cannot find vertex index in facet vertex")})}).filter(n=>n.length===4)}_buildAdjacency(){this.adjacency.clear(),this.tetrahedra.forEach((e,n)=>{const t=[[e[0],e[1],e[2]],[e[0],e[1],e[3]],[e[0],e[2],e[3]],[e[1],e[2],e[3]]];for(const a of t){const o=a.sort((u,s)=>u-s).join("-");this.adjacency.has(o)||this.adjacency.set(o,[]),this.adjacency.get(o).push(n)}})}_computeVoronoi(e){const n=e==="barycenter"?ur:ar;this.voronoiVertices=this.tetrahedra.map(o=>{const u=this.points[o[0]],s=this.points[o[1]],i=this.points[o[2]],f=this.points[o[3]];return n(u,s,i,f)});const t=this.voronoiVertices.map((o,u)=>({vertex:o,index:u})).filter(o=>o.vertex!==null),a=new Map(t.map((o,u)=>[o.index,u]));this.voronoiVertices=t.map(o=>o.vertex),this.voronoiEdges=[];for(const o of this.adjacency.values())if(o.length===2){const u=o[0],s=o[1];if(a.has(u)&&a.has(s)){const i=a.get(u),f=a.get(s);this.voronoiEdges.push([this.voronoiVertices[i],this.voronoiVertices[f]])}}}getStats(){return{pointCount:this.points.length,tetrahedraCount:this.tetrahedra.length,voronoiVertexCount:this.voronoiVertices.length,voronoiEdgeCount:this.voronoiEdges.length,faceCount:this.adjacency.size,hasComputed:this.tetrahedra.length>0}}getDelaunayEdges(){const e=new Set;for(const n of this.tetrahedra){const t=[[n[0],n[1]],[n[0],n[2]],[n[0],n[3]],[n[1],n[2]],[n[1],n[3]],[n[2],n[3]]];for(const a of t){const o=a.sort((u,s)=>u-s);e.add(`${o[0]}-${o[1]}`)}}return e}}m.DelaunayVoronoi=B,m.default=B,Object.defineProperties(m,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
